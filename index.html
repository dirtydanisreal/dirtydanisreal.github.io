<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DCN Patient List Copy Tool</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  background: #0d1117;
  color: #e6edf3;
  font-family: Arial, sans-serif;
  padding: 20px;
}
button {
  padding: 8px 14px;
  margin: 6px 0;
}
textarea {
  width: 100%;
  height: 340px;
  background: #010409;
  color: #0f0;
  padding: 10px;
  white-space: pre;
  font-family: Consolas, monospace;
}
canvas {
  display: none;
}
</style>
</head>

<body>

<h2>DCN Patient List Copy Tool</h2>

<input type="file" id="pdfInput" accept="application/pdf">
<br>
<button onclick="runOCR()">Run It!</button>
<button onclick="copyText()">Copy to Clipboard</button>

<h3>OCR Output</h3>
<textarea id="output"></textarea>

<canvas id="canvas"></canvas>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let finalText = "";

async function runOCR() {
  const file = document.getElementById("pdfInput").files[0];
  if (!file) return alert("Select a PDF");

  finalText = "";
  document.getElementById("output").value = "Processing...\n";

  const pdfData = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
    const page = await pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 2.5 });

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport }).promise;

    const img = canvas.toDataURL("image/png");

    const ocr = await Tesseract.recognize(img, "eng", {
      tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
      preserve_interword_spaces: "1"
    });

    finalText += rebuildFromLines(ocr.data.lines) + "\n";
  }

  document.getElementById("output").value = finalText;
}

function rebuildFromLines(lines) {
  const rows = {};

  for (const line of lines) {
    const y = Math.round(line.bbox.y0 / 8);
    if (!rows[y]) rows[y] = [];
    rows[y].push(line);
  }

  const sortedRows = Object.keys(rows)
    .map(Number)
    .sort((a, b) => a - b);

  let text = "";

  for (const y of sortedRows) {
    const row = rows[y].sort((a, b) => a.bbox.x0 - b.bbox.x0);
    let line = "";
    let cursor = 0;

    for (const item of row) {
      const x = Math.floor(item.bbox.x0 / 8);
      const spaces = Math.max(0, x - cursor);
      line += " ".repeat(spaces) + item.text;
      cursor = x + item.text.length;
    }

    text += line.trimEnd() + "\n";
  }

  return text;
}

async function copyText() {
  if (!finalText) return alert("Nothing to copy");
  await navigator.clipboard.writeText(finalText);
  alert("Copied to clipboard");
}
</script>

</body>
</html>
